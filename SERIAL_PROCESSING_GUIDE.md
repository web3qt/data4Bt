# 串行处理模式说明

## 修改概述

根据您的要求，我已经将 Binance 数据下载程序从并行处理模式改为串行处理模式。现在程序会按代币顺序逐个处理，确保一个代币的所有历史数据完成后再处理下一个代币。

## 主要修改内容

### 1. 调度器任务排序逻辑修改

**文件**: `pkg/scheduler/scheduler.go`

**修改点**: `generateTasksWithEndDate` 方法
- **原逻辑**: 按日期排序，同日期内按代币排序
- **新逻辑**: 按代币分组，同代币内按日期排序

```go
// 按代币分组，然后按日期排序 - 串行处理每个代币
sort.Slice(allTasks, func(i, j int) bool {
    // 首先按代币排序，确保同一代币的任务连续
    if allTasks[i].Symbol != allTasks[j].Symbol {
        return allTasks[i].Symbol < allTasks[j].Symbol
    }
    // 同一代币内按日期排序
    return allTasks[i].Date.Before(allTasks[j].Date)
})
```

### 2. 任务处理逻辑重构

**文件**: `pkg/scheduler/scheduler.go`

**修改点**: `processTasks` 方法
- **原逻辑**: 按批次并行处理多个代币的任务
- **新逻辑**: 按代币分组，串行处理每个代币的所有任务

**主要改进**:
1. 将任务按代币分组
2. 按字母顺序处理代币
3. 每个代币的所有任务完成后才开始下一个代币
4. 增加详细的日志记录，便于跟踪进度

### 3. 状态重置

- 删除了旧的状态文件 `state/progress.json`
- 重新初始化了数据库，清空所有数据
- 确保从干净的状态开始串行处理

## 处理流程

### 当前处理顺序

根据代币名称字母排序，处理顺序为：
1. **ADAUSDT** ✅ (已完成 7 个任务)
2. **AVAXUSDT** 🔄 (正在处理，已完成 6 个任务)
3. **BNBUSDT** ⏳ (等待中)
4. **BTCUSDT** ⏳ (等待中)
5. **DOGEUSDT** ⏳ (等待中)
6. **DOTUSDT** ⏳ (等待中)
7. **ETHUSDT** ⏳ (等待中)
8. **LTCUSDT** ⏳ (等待中)
9. **SOLUSDT** ⏳ (等待中)
10. **XRPUSDT** ⏳ (等待中)

### 每个代币的处理内容

每个代币会处理最近 12 个月的 1 分钟 K 线数据：
- 2024-07 到 2025-06 的月度数据
- 每个月约 40,000+ 条 K 线记录
- 数据下载、解析、验证、导入到 ClickHouse

## 优势

### 1. 状态跟踪更清晰
- 可以明确知道当前正在处理哪个代币
- 每个代币的完成状态一目了然
- 便于在中断后恢复处理

### 2. 资源使用更稳定
- 避免了多代币并行处理的资源竞争
- 内存使用更加可控
- 网络请求更加有序

### 3. 错误处理更简单
- 如果某个代币处理失败，不会影响其他代币
- 可以针对特定代币进行重试
- 日志更加清晰，便于问题定位

## 状态查询

使用以下命令查看当前处理状态：

```bash
# 查看所有代币状态
./status.sh

# 查看详细状态
./status.sh -d

# 查看特定代币状态
./status.sh BTCUSDT
```

## 预期完成时间

基于当前处理速度（每个代币约 7 个任务，每个任务约 5 秒）：
- 每个代币预计需要 35-40 秒完成
- 10 个代币总计约 6-7 分钟完成所有历史数据下载

## 注意事项

1. **不要中断正在处理的代币**: 等待当前代币完成后再停止程序
2. **状态文件自动保存**: 每个任务完成后都会更新状态文件
3. **断点续传**: 程序重启后会从上次中断的位置继续
4. **日志监控**: 可以通过日志实时了解处理进度

现在您可以清楚地看到每个代币的处理状态，BTC 等重要代币的数据完整性也更容易验证。