# Binance Data Loader

ä¸€ä¸ªé«˜æ€§èƒ½çš„å¸å®‰Kçº¿æ•°æ®ä¸‹è½½å’Œå¤„ç†ç³»ç»Ÿï¼Œæ”¯æŒä»å¸å®‰å®˜æ–¹æ•°æ®æºä¸‹è½½å†å²Kçº¿æ•°æ®ï¼Œè§£æCSVæ–‡ä»¶ï¼ŒéªŒè¯æ•°æ®å®Œæ•´æ€§ï¼Œå¹¶å°†æ•°æ®å¯¼å…¥åˆ°ClickHouseæ•°æ®åº“ä¸­ã€‚ç³»ç»Ÿè¿˜æ”¯æŒåˆ›å»ºå¤šæ—¶é—´å‘¨æœŸçš„ç‰©åŒ–è§†å›¾ï¼Œä¾¿äºåç»­çš„æ•°æ®åˆ†æå’ŒæŸ¥è¯¢ã€‚

## åŠŸèƒ½ç‰¹æ€§

### æ ¸å¿ƒåŠŸèƒ½

- ğŸš€ **é«˜æ€§èƒ½ä¸‹è½½**: æ”¯æŒå¹¶å‘ä¸‹è½½ï¼Œè‡ªåŠ¨é‡è¯•æœºåˆ¶
- ğŸ“Š **æ•°æ®éªŒè¯**: å®Œæ•´çš„CSVæ•°æ®éªŒè¯å’Œè´¨é‡æ£€æŸ¥
- ğŸ—„ï¸ **ClickHouseé›†æˆ**: é«˜æ•ˆçš„åˆ—å¼æ•°æ®åº“å­˜å‚¨
- â±ï¸ **ç‰©åŒ–è§†å›¾**: è‡ªåŠ¨åˆ›å»º5mã€15mã€1hã€4hã€1dç­‰å¤šæ—¶é—´å‘¨æœŸè§†å›¾
- ğŸ“ˆ **è¿›åº¦ç›‘æ§**: å®æ—¶è¿›åº¦æŠ¥å‘Šå’ŒWebä»ªè¡¨æ¿
- ğŸ”„ **çŠ¶æ€ç®¡ç†**: æ”¯æŒæ–­ç‚¹ç»­ä¼ å’Œå¢é‡æ›´æ–°
- ğŸ“ **ç»“æ„åŒ–æ—¥å¿—**: è¯¦ç»†çš„æ“ä½œæ—¥å¿—å’Œæ€§èƒ½æŒ‡æ ‡

### æŠ€æœ¯ç‰¹æ€§

- **å¹¶å‘å¤„ç†**: æ”¯æŒå¤šåç¨‹å¹¶å‘ä¸‹è½½å’Œå¤„ç†
- **å†…å­˜ä¼˜åŒ–**: æµå¼å¤„ç†å¤§æ–‡ä»¶ï¼Œæ§åˆ¶å†…å­˜ä½¿ç”¨
- **é”™è¯¯æ¢å¤**: è‡ªåŠ¨é‡è¯•å’Œé”™è¯¯å¤„ç†æœºåˆ¶
- **é…ç½®çµæ´»**: æ”¯æŒYAMLé…ç½®æ–‡ä»¶
- **ç›‘æ§å‹å¥½**: æä¾›HTTP APIå’ŒWebç•Œé¢

## ç³»ç»Ÿæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Scheduler     â”‚â”€â”€â”€â–¶â”‚    Downloader   â”‚â”€â”€â”€â–¶â”‚     Parser      â”‚
â”‚   (è°ƒåº¦å™¨)       â”‚    â”‚    (ä¸‹è½½å™¨)      â”‚    â”‚    (è§£æå™¨)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                       â”‚                       â”‚
         â–¼                       â–¼                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ State Manager   â”‚    â”‚   Importer      â”‚    â”‚  ClickHouse     â”‚
â”‚  (çŠ¶æ€ç®¡ç†)      â”‚    â”‚   (å¯¼å…¥å™¨)       â”‚    â”‚   Repository    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                       â”‚                       â”‚
         â–¼                       â–¼                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚Progress Reporterâ”‚    â”‚   Buffer        â”‚    â”‚ Materialized    â”‚
â”‚  (è¿›åº¦æŠ¥å‘Š)      â”‚    â”‚   (ç¼“å†²åŒº)       â”‚    â”‚    Views        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## å¿«é€Ÿå¼€å§‹

### 1. ç¯å¢ƒè¦æ±‚

- Go 1.19+
- ClickHouse 21.8+
- ç½‘ç»œè¿æ¥ï¼ˆè®¿é—®å¸å®‰æ•°æ®æºï¼‰

### 2. å®‰è£…ä¾èµ–

```bash
go mod download
```

### 3. é…ç½®æ–‡ä»¶

å¤åˆ¶å¹¶ä¿®æ”¹é…ç½®æ–‡ä»¶ï¼š

```bash
cp config.yml.example config.yml
```

ä¸»è¦é…ç½®é¡¹ï¼š

```yaml
# ClickHouseæ•°æ®åº“é…ç½®
database:
  hosts: ["localhost:9000"]
  database: "binance_data"
  username: "default"
  password: ""

# è°ƒåº¦å™¨é…ç½®
scheduler:
  end_date: ""
  batch_days: 7
  concurrent_symbols: 5
```

### 4. åˆå§‹åŒ–æ•°æ®åº“

```bash
go run cmd/main.go -cmd=init-db
```

### 5. å¯åŠ¨ClickHouseæ•°æ®åº“

åœ¨è¿è¡Œä¸»ç¨‹åºä¹‹å‰ï¼Œéœ€è¦å…ˆå¯åŠ¨ClickHouseæ•°æ®åº“ï¼š

```bash
# ä½¿ç”¨Docker Composeå¯åŠ¨ClickHouse
docker compose up -d clickhouse

# éªŒè¯ClickHouseæ˜¯å¦æ­£å¸¸è¿è¡Œ
docker compose ps clickhouse

# æµ‹è¯•è¿æ¥
curl http://localhost:8123/ping
```

#### æ•…éšœæ’é™¤

å¦‚æœé‡åˆ°è®¤è¯å¤±è´¥é”™è¯¯ï¼ˆAuthentication failedï¼‰ï¼Œè¯·ä½¿ç”¨æä¾›çš„é‡å¯è„šæœ¬ï¼š

```bash
# è¿è¡Œé‡å¯è„šæœ¬ï¼ˆä¼šè‡ªåŠ¨é‡å¯å®¹å™¨å¹¶æµ‹è¯•è¿æ¥ï¼‰
./restart_clickhouse.sh
```

æˆ–è€…æ‰‹åŠ¨é‡å¯ï¼š

```bash
# åœæ­¢å¹¶é‡æ–°å¯åŠ¨ClickHouse
docker compose down clickhouse
docker compose up -d clickhouse

# ç­‰å¾…30-60ç§’è®©å®¹å™¨å®Œå…¨å¯åŠ¨
sleep 30

# æµ‹è¯•è¿æ¥
curl http://localhost:8123/ping
```

### 6. è¿è¡Œæ•°æ®åŠ è½½

```bash
# å¤åˆ¶é…ç½®æ–‡ä»¶åˆ°é¡¹ç›®æ ¹ç›®å½•ï¼ˆå¦‚æœè¿˜æ²¡æœ‰çš„è¯ï¼‰
cp configs/config.yml config.yml

# åˆå§‹åŒ–æ•°æ®åº“è¡¨
go run cmd/main.go -cmd=init-db

# åŠ è½½æŒ‡å®šæ—¥æœŸèŒƒå›´çš„æ•°æ®
go run cmd/main.go -cmd=run -start=2024-01-01 -end=2024-01-31

# åŠ è½½æŒ‡å®šäº¤æ˜“å¯¹çš„æ•°æ®
go run cmd/main.go -cmd=run -symbols=BTCUSDT,ETHUSDT -start=2024-01-01 -end=2024-01-07
```

### 7. åˆ›å»ºç‰©åŒ–è§†å›¾

```bash
go run cmd/main.go -cmd=create-views
```

## å¿«é€Ÿæµ‹è¯•

å¦‚æœä½ æƒ³å¿«é€ŸéªŒè¯ç³»ç»ŸåŠŸèƒ½è€Œä¸éœ€è¦å®‰è£…Dockerå’ŒClickHouseï¼Œå¯ä»¥ä½¿ç”¨ç®€åŒ–æµ‹è¯•ï¼š

```bash
# è¿è¡Œç®€åŒ–æµ‹è¯•ï¼ˆåªæµ‹è¯•æ•°æ®ä¸‹è½½å’Œè§£æï¼‰
go run test/btc_test_simple.go
```

è¿™ä¸ªæµ‹è¯•ä¼šï¼š
- ä¸‹è½½å¸å®‰å†å²æ•°æ®
- è§£æCSVæ ¼å¼çš„Kçº¿æ•°æ®
- éªŒè¯æ•°æ®å®Œæ•´æ€§
- æ˜¾ç¤ºç¤ºä¾‹æ•°æ®

è¯¦ç»†çš„æµ‹è¯•è¯´æ˜è¯·å‚è€ƒ [test/README.md](test/README.md)

## ä½¿ç”¨æŒ‡å—

### å‘½ä»¤è¡Œé€‰é¡¹

```bash
ä½¿ç”¨æ–¹æ³•: ./binance-data-loader [é€‰é¡¹]

å‘½ä»¤:
  run        - è¿è¡Œæ•°æ®åŠ è½½å™¨ (é»˜è®¤)
  validate   - éªŒè¯ç°æœ‰æ•°æ®
  init-db    - åˆå§‹åŒ–æ•°æ®åº“è¡¨
  create-views - åˆ›å»ºç‰©åŒ–è§†å›¾

é€‰é¡¹:
  -config string
        é…ç½®æ–‡ä»¶è·¯å¾„ (é»˜è®¤ "config.yml")
  -cmd string
        è¦æ‰§è¡Œçš„å‘½ä»¤ (é»˜è®¤ "run")
  -symbols string
        è¦å¤„ç†çš„äº¤æ˜“å¯¹åˆ—è¡¨ï¼Œé€—å·åˆ†éš” (å¯é€‰)
  -start string
        å¼€å§‹æ—¥æœŸ (YYYY-MM-DD)
  -end string
        ç»“æŸæ—¥æœŸ (YYYY-MM-DD)
  -verbose
        å¯ç”¨è¯¦ç»†æ—¥å¿—
  -version
        æ˜¾ç¤ºç‰ˆæœ¬ä¿¡æ¯
```

### é…ç½®è¯´æ˜

#### æ•°æ®åº“é…ç½®

```yaml
database:
  hosts: ["localhost:9000"]  # ClickHouseæœåŠ¡å™¨åœ°å€
  database: "binance_data"    # æ•°æ®åº“åç§°
  username: "default"         # ç”¨æˆ·å
  password: ""                # å¯†ç 
  dial_timeout: "10s"         # è¿æ¥è¶…æ—¶
  max_open_conns: 10          # æœ€å¤§è¿æ¥æ•°
  max_idle_conns: 5           # æœ€å¤§ç©ºé—²è¿æ¥æ•°
  conn_max_lifetime: "1h"     # è¿æ¥æœ€å¤§ç”Ÿå­˜æ—¶é—´
  compression: "lz4"          # å‹ç¼©ç®—æ³•
```

#### ä¸‹è½½å™¨é…ç½®

```yaml
downloader:
  concurrency: 5              # å¹¶å‘ä¸‹è½½æ•°
  buffer_size: 1024           # ç¼“å†²åŒºå¤§å°
  user_agent: "BinanceDataLoader/1.0"
  compression: true           # å¯ç”¨å‹ç¼©
  max_file_size: 104857600    # æœ€å¤§æ–‡ä»¶å¤§å° (100MB)
```

#### å¯¼å…¥å™¨é…ç½®

```yaml
importer:
  batch_size: 1000            # æ‰¹æ¬¡å¤§å°
  buffer_size: 10000          # ç¼“å†²åŒºå¤§å°
  flush_interval: "30s"       # åˆ·æ–°é—´éš”
  deduplication: true         # å¯ç”¨å»é‡
```

### ç›‘æ§å’Œè¿›åº¦

å¯ç”¨ç›‘æ§åï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼æŸ¥çœ‹è¿›åº¦ï¼š

1. **Webä»ªè¡¨æ¿**: è®¿é—® `http://localhost:8080`
2. **APIæ¥å£**:
   - æ€»ä½“è¿›åº¦: `GET /progress`
   - è¯¦ç»†è¿›åº¦: `GET /progress/detailed`
   - äº¤æ˜“å¯¹è¿›åº¦: `GET /progress/symbol/{symbol}`
   - å¥åº·æ£€æŸ¥: `GET /health`

### æ•°æ®è¡¨ç»“æ„

#### ä¸»è¡¨ (klines_1m)

```sql
CREATE TABLE klines_1m (
    symbol String,
    open_time DateTime64(3),
    close_time DateTime64(3),
    open_price Float64,
    high_price Float64,
    low_price Float64,
    close_price Float64,
    volume Float64,
    quote_asset_volume Float64,
    number_of_trades Int64,
    taker_buy_base_volume Float64,
    taker_buy_quote_volume Float64,
    interval String,
    created_at DateTime DEFAULT now()
) ENGINE = MergeTree()
PARTITION BY (symbol, toYYYYMM(open_time))
ORDER BY (symbol, open_time)
```

#### ç‰©åŒ–è§†å›¾

ç³»ç»Ÿä¼šè‡ªåŠ¨åˆ›å»ºä»¥ä¸‹æ—¶é—´å‘¨æœŸçš„ç‰©åŒ–è§†å›¾ï¼š

- `klines_5m` - 5åˆ†é’ŸKçº¿
- `klines_15m` - 15åˆ†é’ŸKçº¿
- `klines_1h` - 1å°æ—¶Kçº¿
- `klines_4h` - 4å°æ—¶Kçº¿
- `klines_1d` - 1å¤©Kçº¿

## æ€§èƒ½ä¼˜åŒ–

### ä¸‹è½½æ€§èƒ½

- è°ƒæ•´ `downloader.concurrency` æ§åˆ¶å¹¶å‘ä¸‹è½½æ•°
- è®¾ç½®åˆé€‚çš„ `downloader.buffer_size` ä¼˜åŒ–å†…å­˜ä½¿ç”¨
- å¯ç”¨å‹ç¼©å‡å°‘ç½‘ç»œä¼ è¾“

### å¯¼å…¥æ€§èƒ½

- å¢åŠ  `importer.batch_size` æé«˜æ‰¹é‡æ’å…¥æ•ˆç‡
- è°ƒæ•´ `importer.buffer_size` æ§åˆ¶å†…å­˜ç¼“å†²
- è®¾ç½®åˆé€‚çš„ `importer.flush_interval` å¹³è¡¡æ€§èƒ½å’Œå®æ—¶æ€§

### æ•°æ®åº“æ€§èƒ½

- ä½¿ç”¨SSDå­˜å‚¨æé«˜I/Oæ€§èƒ½
- è°ƒæ•´ClickHouseçš„ `max_memory_usage` è®¾ç½®
- å®šæœŸæ‰§è¡Œ `OPTIMIZE TABLE` ä¼˜åŒ–æ•°æ®å­˜å‚¨

## æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **è¿æ¥ClickHouseå¤±è´¥**
   - æ£€æŸ¥æ•°æ®åº“æœåŠ¡æ˜¯å¦è¿è¡Œ
   - éªŒè¯è¿æ¥é…ç½®å’Œå‡­æ®
   - ç¡®è®¤ç½‘ç»œè¿æ¥

2. **ä¸‹è½½å¤±è´¥**
   - æ£€æŸ¥ç½‘ç»œè¿æ¥
   - éªŒè¯å¸å®‰æ•°æ®æºå¯è®¿é—®æ€§
   - è°ƒæ•´é‡è¯•é…ç½®

3. **å†…å­˜ä½¿ç”¨è¿‡é«˜**
   - å‡å°‘å¹¶å‘æ•°å’Œç¼“å†²åŒºå¤§å°
   - å¢åŠ åˆ·æ–°é¢‘ç‡
   - ç›‘æ§ç³»ç»Ÿèµ„æºä½¿ç”¨

4. **æ•°æ®éªŒè¯å¤±è´¥**
   - æ£€æŸ¥CSVæ–‡ä»¶æ ¼å¼
   - éªŒè¯æ•°æ®å®Œæ•´æ€§
   - æŸ¥çœ‹è¯¦ç»†é”™è¯¯æ—¥å¿—

### æ—¥å¿—åˆ†æ

ç³»ç»Ÿæä¾›è¯¦ç»†çš„ç»“æ„åŒ–æ—¥å¿—ï¼š

```bash
# æŸ¥çœ‹é”™è¯¯æ—¥å¿—
grep "level":"error" logs/app.log

# æŸ¥çœ‹æ€§èƒ½æŒ‡æ ‡
grep "performance" logs/app.log

# æŸ¥çœ‹æ•°æ®è´¨é‡æŠ¥å‘Š
grep "data_quality" logs/app.log
```

## å¼€å‘æŒ‡å—

### é¡¹ç›®ç»“æ„

```
.
â”œâ”€â”€ cmd/                    # åº”ç”¨ç¨‹åºå…¥å£
â”‚   â””â”€â”€ main.go
â”œâ”€â”€ internal/               # å†…éƒ¨åŒ…
â”‚   â”œâ”€â”€ config/            # é…ç½®ç®¡ç†
â”‚   â”œâ”€â”€ domain/            # é¢†åŸŸæ¨¡å‹
â”‚   â”œâ”€â”€ logger/            # æ—¥å¿—ç³»ç»Ÿ
â”‚   â””â”€â”€ state/             # çŠ¶æ€ç®¡ç†
â”œâ”€â”€ pkg/                   # å…¬å…±åŒ…
â”‚   â”œâ”€â”€ binance/           # å¸å®‰æ•°æ®ä¸‹è½½
â”‚   â”œâ”€â”€ clickhouse/        # ClickHouseå­˜å‚¨
â”‚   â”œâ”€â”€ importer/          # æ•°æ®å¯¼å…¥
â”‚   â”œâ”€â”€ monitor/           # ç›‘æ§æŠ¥å‘Š
â”‚   â”œâ”€â”€ parser/            # CSVè§£æ
â”‚   â””â”€â”€ scheduler/         # ä»»åŠ¡è°ƒåº¦
â”œâ”€â”€ config.yml             # é…ç½®æ–‡ä»¶
â”œâ”€â”€ go.mod                 # Goæ¨¡å—
â””â”€â”€ README.md              # è¯´æ˜æ–‡æ¡£
```

### æ‰©å±•å¼€å‘

1. **æ·»åŠ æ–°çš„æ•°æ®æº**
   - å®ç° `domain.Downloader` æ¥å£
   - æ·»åŠ ç›¸åº”çš„é…ç½®é€‰é¡¹

2. **æ”¯æŒæ–°çš„å­˜å‚¨åç«¯**
   - å®ç° `domain.KLineRepository` æ¥å£
   - æ·»åŠ ç›¸åº”çš„é…ç½®å’Œåˆå§‹åŒ–ä»£ç 

3. **è‡ªå®šä¹‰æ•°æ®å¤„ç†**
   - å®ç° `domain.Parser` æ¥å£
   - æ·»åŠ æ•°æ®éªŒè¯å’Œè½¬æ¢é€»è¾‘

## è®¸å¯è¯

MIT License

## è´¡çŒ®

æ¬¢è¿æäº¤Issueå’ŒPull Requestï¼

## æ›´æ–°æ—¥å¿—

### v1.0.0

- åˆå§‹ç‰ˆæœ¬å‘å¸ƒ
- æ”¯æŒå¸å®‰Kçº¿æ•°æ®ä¸‹è½½
- ClickHouseæ•°æ®å­˜å‚¨
- ç‰©åŒ–è§†å›¾æ”¯æŒ
- Webç›‘æ§ç•Œé¢
